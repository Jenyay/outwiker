version: 4.0.0.xxx.{build}
image:
    - Visual Studio 2022
    - Ubuntu2004
environment:
    PY_PYTHON: 3.8
    PY_DIR: C:\Python38-x64
    PYTHONIOENCODING: utf_8
stack: Python 3.8
init:
    - cmd: set PATH=%PY_DIR%;%PY_DIR%\Scripts;%PATH%
    - cmd: py -%PY_PYTHON% -m pip install uv
    - sh: sudo apt update --allow-releaseinfo-change
    - sh: sudo apt-get -y install python3-pip python3-dev debhelper devscripts debhelper devscripts p7zip-full libssl-dev dpkg-dev build-essential libpng-dev libjpeg-dev libtiff-dev libsdl2-dev libnotify-dev freeglut3 ibus-gtk3 xvfb libhunspell-dev libgstreamer1.0-0
    - sh: sudo apt-get -y install libwebkit2gtk-4.0
install:
    - git submodule update --init --recursive
    - cmd: choco install innosetup -y
    - cmd: uv venv --python %PY_PYTHON%
    - cmd: .venv/Scripts/activate
    - cmd: uv sync --dev
    #- cmd: uv pip install -e ./owbuildtools
    - cmd: uv pip install -e .
    - cmd: uv pip list
    - sh: export PATH="$HOME/.local/bin:$PATH"
    - sh: python3 -m pip install uv
    #- sh: python3 -m pip install pipx
    #- sh: pipx ensurepath
    #- sh: pipx install uv
    #- sh: export PATH="$HOME/.local/bin:$PATH"
    #- sh: python3 -m uv venv
    #- sh: python3 -m uv pip install -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-20.04 wxPython==4.2.1
    #- sh: python3 -m uv sync --dev --active
    #- sh: python3 -m uv pip install -e ./owbuildtools
    #- sh: python3 -m uv pip install -e .
    #- sh: python3 -m uv pip list
    - sh: uv venv --python 3.11
    - sh: source .venv/bin/activate
    - sh: uv pip install -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-20.04 wxPython==4.2.2
    - sh: uv sync --dev
    #- sh: uv pip install -e ./owbuildtools
    - sh: uv pip install -e .
    - sh: uv pip list
build_script:
    - cmd: uv run inv win
test_script:
    - sh: xvfb-run uv run --active inv test -p src/outwiker/tests
    - cmd: uv run inv test -p src/outwiker/tests
    #- cmd: uv run pytest src/outwiker/tests
artifacts:
    - path: build/*/versions.xml
      name: versions.xml
    - path: build\*\windows\*.zip
      name: windows_zip
    - path: build\*\windows\*.exe
      name: windows_installer
    - path: build\*\windows\*.7z
      name: windows_7z
    - path: build/*/linux/*.zip
      name: linux_zip
    - path: build/*/linux/*.7z
      name: linux_7z
    - path: build/*/linux/*.deb
      name: linux_deb
    - path: build/*/linux/*.AppImage
      name: linux_AppImage
    - path: build\*\plugins\*\*.zip
      name: plugins
